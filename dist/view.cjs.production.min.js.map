{"version":3,"file":"view.cjs.production.min.js","sources":["../src/html.ts","../src/render.ts","../src/reactivity.ts","../src/scheduler.ts","../src/directive.ts","../src/directives/text.ts","../src/directives/input.ts","../src/component.ts"],"sourcesContent":["const isLetter = (c: string): boolean => {\n  return c.toLowerCase() != c.toUpperCase();\n};\n\nexport enum DirectiveType {\n  TEXT,\n  ATTRIBUTE,\n  ATTRIBUTE_VALUE,\n}\nexport interface DirectiveData {\n  d: Function;\n  t?: DirectiveType;\n  a?: string;\n  n?: Node;\n}\nconst insertAttributeMarker = (\n  marker: string,\n  si: number,\n  appendedStatic: string\n): string => {\n  while (si++) {\n    const char = appendedStatic.charAt(si);\n    if (!char) {\n      break;\n    }\n    if (char === ' ') {\n      return (\n        appendedStatic.slice(0, si) + ' ' + marker + appendedStatic.slice(si)\n      );\n    }\n  }\n  return appendedStatic;\n};\nexport const getTextMarker = (id: number): string => {\n  return `tm-${id}`;\n};\nexport const getAttributeMarker = (id: number): string => {\n  return `data-am-${id}`;\n};\nexport interface HTMLResult {\n  template: HTMLTemplateElement;\n  directives: DirectiveData[];\n}\nlet resultCache: WeakMap<TemplateStringsArray, HTMLResult> = new WeakMap();\nexport const html = (\n  staticParts: TemplateStringsArray,\n  ...dynamicParts: any[]\n): HTMLResult => {\n  let result: HTMLResult = resultCache.get(staticParts);\n  if (!result) {\n    let appendedStatic: string = '';\n    const directives: DirectiveData[] = [];\n    for (let i = 0; i < dynamicParts.length; i++) {\n      const dynamicPart = dynamicParts[i];\n      const staticPart = staticParts[i];\n      appendedStatic += staticPart;\n      if (typeof dynamicPart !== 'function') {\n        appendedStatic += dynamicPart;\n        continue;\n      }\n      let id =\n        directives.push({\n          d: dynamicPart,\n        }) - 1;\n      let si = appendedStatic.length + 1;\n      let attributeValueMode = false;\n      let attributeMode = false;\n      let attributeNameFound = false;\n      let attributeName = '';\n      while (si--) {\n        const char = appendedStatic.charAt(si);\n        const nextChar = appendedStatic.charAt(si - 1);\n        const nextNextChar = appendedStatic.charAt(si - 2);\n        if (char === '>' || si === 0) {\n          let marker = getTextMarker(id);\n          appendedStatic += `<${marker}>&zwnj;</${marker}>`;\n          directives[id].t = DirectiveType.TEXT;\n          break;\n        }\n        if (\n          char === '\"' &&\n          nextChar === '=' &&\n          isLetter(nextNextChar) &&\n          !attributeMode\n        ) {\n          attributeValueMode = true;\n          continue;\n        }\n        if (char === '\"' && nextNextChar !== '=' && !attributeValueMode) {\n          attributeValueMode = false;\n          attributeMode = true;\n          continue;\n        }\n        if (\n          attributeValueMode &&\n          char !== '\"' &&\n          char !== '=' &&\n          !attributeNameFound\n        ) {\n          if (char !== ' ') {\n            attributeName = char + attributeName;\n          } else {\n            attributeNameFound = true;\n          }\n        }\n        if (char === '<' && attributeValueMode) {\n          appendedStatic = insertAttributeMarker(\n            getAttributeMarker(id),\n            si,\n            appendedStatic\n          );\n          directives[id].t = DirectiveType.ATTRIBUTE_VALUE;\n          directives[id].a = attributeName;\n          if (appendedStatic[appendedStatic.length - 1] === ' ') {\n            appendedStatic = appendedStatic.slice(0, appendedStatic.length - 1);\n          }\n          break;\n        }\n        if (char === '<' && !attributeValueMode) {\n          appendedStatic = insertAttributeMarker(\n            getAttributeMarker(id),\n            si,\n            appendedStatic\n          );\n          directives[id].t = DirectiveType.ATTRIBUTE;\n          break;\n        }\n      }\n    }\n    appendedStatic += staticParts[staticParts.length - 1];\n    const template = document.createElement('template');\n    template.innerHTML = appendedStatic;\n    result = {\n      template,\n      directives,\n    };\n  } else {\n    let directiveIndex: number = 0;\n    dynamicParts.forEach((value: any) => {\n      if (typeof value === 'function') {\n        result.directives[directiveIndex].d = value;\n        directiveIndex++;\n      }\n    });\n  }\n  resultCache.set(staticParts, result);\n  return result;\n};\n","import {\n  HTMLResult,\n  DirectiveType,\n  getTextMarker,\n  getAttributeMarker,\n} from './html';\n\nconst childNodesMap: WeakMap<HTMLElement, NodeList> = new WeakMap();\nexport const render = (\n  container: HTMLElement,\n  htmlResult: HTMLResult\n): void => {\n  if (!childNodesMap.has(container)) {\n    const fragment: DocumentFragment = htmlResult.template.content.cloneNode(\n      true\n    ) as DocumentFragment;\n    htmlResult.directives.forEach((directiveData, id) => {\n      switch (directiveData.t) {\n        case DirectiveType.TEXT:\n          const placeholder = fragment.querySelector(getTextMarker(id));\n          const textNode = placeholder.firstChild;\n          directiveData.n = textNode;\n          placeholder.parentElement.replaceChild(textNode, placeholder);\n          break;\n        case DirectiveType.ATTRIBUTE:\n        case DirectiveType.ATTRIBUTE_VALUE:\n          const marker = getAttributeMarker(id);\n          const node = fragment.querySelector(`[${marker}]`);\n          node.removeAttribute(marker);\n          directiveData.n = node;\n      }\n    });\n    childNodesMap.set(container, fragment.childNodes);\n    container.appendChild(fragment);\n  }\n  htmlResult.directives.forEach(directiveData => {\n    directiveData.d(directiveData.n);\n  });\n};\n","const IS_PROXY = Symbol('$P');\nfunction proxify(obj: any, onChange: () => void): any {\n  const proxy = new Proxy(obj, {\n    get: (obj, prop) => {\n      if (\n        obj[prop] &&\n        typeof obj[prop] === 'object' &&\n        obj[prop].__$p !== IS_PROXY\n      ) {\n        obj[prop] = proxify(obj[prop], onChange);\n      }\n      return obj[prop];\n    },\n    set: (obj, prop, value) => {\n      if (obj[prop] !== value && prop !== '__$p') {\n        obj[prop] = value;\n        onChange();\n      }\n      return true;\n    },\n  });\n  proxy.__$p = IS_PROXY;\n  return proxy;\n}\nlet onStateChanged: () => void;\nexport const setUpState = <CB extends () => any>(\n  cb: CB,\n  onChange: () => void\n): ReturnType<CB> => {\n  onStateChanged = onChange;\n  let result = cb();\n  onStateChanged = undefined;\n  return result;\n};\nexport const state = <S extends {} = {}>(initialState: Partial<S> = {}): S => {\n  let onChange = onStateChanged;\n  return proxify(initialState, () => onChange && onChange());\n};\n","export enum PriorityLevel {\n  IMMEDIATE = 0, //synchronous\n  USER_BLOCKING = 250, //.25s timeout\n  NORMAL = 5000, // 5s timeout\n  LOW = 10000, // 10s timeout\n  IDLE = 99999999, // no timeout (run only when nothing else is scheduled)\n}\ntype ScheduledJob = [() => void, number, number];\nlet scheduledJobs: ScheduledJob[] = [];\nlet schedulerRunning: boolean = false;\nconst MAX_ELAPSED: number = 17;\nconst processJobQueue = (\n  queue: ScheduledJob[],\n  now: number\n): ScheduledJob[] => {\n  return queue.filter(([cb, startTime, timeout]) => {\n    const totalElapsed: number = Date.now() - now;\n    const jobElapsed: number = Date.now() - startTime;\n    if (jobElapsed > timeout || totalElapsed < MAX_ELAPSED) {\n      cb();\n      return false;\n    } else {\n      return true;\n    }\n  });\n};\nconst processScheduledJobs = () => {\n  const now: number = Date.now();\n  const jobsToRun = scheduledJobs;\n  scheduledJobs = [];\n  const remainingJobs = processJobQueue(jobsToRun, now);\n  scheduledJobs = remainingJobs.concat(scheduledJobs);\n  if (scheduledJobs.length > 0) {\n    requestAnimationFrame(processScheduledJobs);\n  } else {\n    schedulerRunning = false;\n  }\n};\nexport const schedule = (\n  cb: () => void,\n  priority: PriorityLevel = PriorityLevel.NORMAL\n): Promise<void> => {\n  if (priority === PriorityLevel.IMMEDIATE) {\n    cb();\n  } else {\n    return new Promise(resolve => {\n      scheduledJobs.push([\n        () => {\n          cb();\n          resolve();\n        },\n        Date.now(),\n        priority,\n      ]);\n      if (!schedulerRunning) {\n        requestAnimationFrame(processScheduledJobs);\n        schedulerRunning = true;\n      }\n    });\n  }\n  return Promise.resolve();\n};\nexport type Schedule = typeof schedule;\n","import { schedule, Schedule } from './scheduler';\n\nexport type Directive<N extends Node = Node, Args extends any[] = any[]> = (\n  ...args: Args\n) => (node: N) => void;\nexport type DirectiveHandler<\n  N extends Node = any,\n  Args extends any[] = any[]\n> = (node: N, schedule: Schedule, ...args: Args) => void;\nexport function createDirective<\n  Args extends any[] = any[],\n  N extends Node = any,\n  D extends DirectiveHandler<N, Args> = DirectiveHandler<N, Args>\n>(\n  handler: D\n): D extends (node: N, schedule: Schedule, ...args: infer A) => void\n  ? Directive<N, A>\n  : never {\n  return ((...args: Args) => {\n    return (node: N) => {\n      handler(node, schedule, ...args);\n    };\n  }) as D extends (node: N, schedule: Schedule, ...args: infer A) => void\n    ? Directive<N, A>\n    : never;\n}\n","import { createDirective } from '../directive';\nimport { Schedule } from '../scheduler';\n\nexport const text = createDirective(\n  (node: Text, schedule: Schedule, value: string) => {\n    if (node instanceof Text) {\n      schedule(() => {\n        node.textContent = value;\n      });\n    }\n  }\n);\n","import { createDirective } from '../directive';\nimport { PriorityLevel, Schedule } from '../scheduler';\n\nconst valueMap: WeakMap<HTMLInputElement, string> = new WeakMap();\nexport const input = createDirective(\n  (node: HTMLInputElement, schedule: Schedule, cb: (value: string) => void) => {\n    if (node instanceof HTMLInputElement) {\n      if (!valueMap.has(node)) {\n        valueMap.set(node, node.value);\n        node.addEventListener('input', e => {\n          const value: string = (e.target as HTMLInputElement).value;\n          if (value !== valueMap.get(node)) {\n            schedule(() => cb(value), PriorityLevel.USER_BLOCKING);\n            valueMap.set(node, value);\n          }\n        });\n      }\n    }\n  }\n);\n","import { HTMLResult } from './html';\nimport { setUpState } from './reactivity';\nimport { render } from './render';\nimport { schedule, PriorityLevel } from './scheduler';\nexport interface ComponentDefinition {\n  render: () => HTMLResult;\n}\nexport type Setup = () => ComponentDefinition;\nexport const component = (name: string, setup: Setup) => {\n  customElements.define(\n    name,\n    class extends HTMLElement {\n      private renderQueued: boolean = false;\n      private render: () => HTMLResult;\n      constructor() {\n        super();\n        this.attachShadow({ mode: 'open' });\n        setUpState(\n          () => (this.render = setup().render),\n          () => {\n            this.performRender();\n          }\n        );\n        this.performRender();\n      }\n\n      private performRender() {\n        if (!this.renderQueued) {\n          this.renderQueued = true;\n          schedule(() => {\n            render(this.shadowRoot as any, this.render());\n          }, PriorityLevel.USER_BLOCKING).then(\n            () => (this.renderQueued = false)\n          );\n        }\n      }\n    }\n  );\n};\n"],"names":["DirectiveType","isLetter","c","toLowerCase","toUpperCase","insertAttributeMarker","marker","si","appendedStatic","char","charAt","slice","getTextMarker","id","getAttributeMarker","resultCache","WeakMap","childNodesMap","render","container","htmlResult","has","fragment","template","content","cloneNode","directives","forEach","directiveData","t","TEXT","placeholder","querySelector","textNode","firstChild","n","parentElement","replaceChild","ATTRIBUTE","ATTRIBUTE_VALUE","node","removeAttribute","set","childNodes","appendChild","d","onStateChanged","PriorityLevel","IS_PROXY","Symbol","setUpState","cb","onChange","result","undefined","scheduledJobs","schedulerRunning","processScheduledJobs","now","Date","jobsToRun","remainingJobs","queue","filter","startTime","timeout","totalElapsed","processJobQueue","concat","length","requestAnimationFrame","schedule","priority","NORMAL","IMMEDIATE","Promise","resolve","push","createDirective","handler","args","text","value","Text","textContent","valueMap","input","HTMLInputElement","addEventListener","e","target","get","USER_BLOCKING","name","setup","customElements","define","attachShadow","mode","_this","performRender","this","renderQueued","_this2","shadowRoot","then","HTMLElement","staticParts","dynamicParts","directiveIndex","i","dynamicPart","staticPart","attributeValueMode","attributeMode","attributeNameFound","attributeName","nextChar","nextNextChar","a","document","createElement","innerHTML","initialState","proxify","obj","proxy","Proxy","prop","__$p"],"mappings":"aAAA,IAIYA,EAJNC,EAAW,SAACC,UACTA,EAAEC,eAAiBD,EAAEE,gBAG9B,SAAYJ,GACVA,mBACAA,6BACAA,yCAHF,CAAYA,IAAAA,OAWZ,IAAMK,EAAwB,SAC5BC,EACAC,EACAC,QAEOD,KAAM,KACLE,EAAOD,EAAeE,OAAOH,OAC9BE,WAGQ,MAATA,SAEAD,EAAeG,MAAM,EAAGJ,GAAM,IAAMD,EAASE,EAAeG,MAAMJ,UAIjEC,GAEII,EAAgB,SAACC,eACfA,GAEFC,EAAqB,SAACD,oBACfA,GAMhBE,EAAyD,IAAIC,QCpC3DC,EAAgD,IAAID,QAC7CE,EAAS,SACpBC,EACAC,OAEKH,EAAcI,IAAIF,GAAY,KAC3BG,EAA6BF,EAAWG,SAASC,QAAQC,WAC7D,GAEFL,EAAWM,WAAWC,SAAQ,SAACC,EAAef,UACpCe,EAAcC,QACf7B,EAAc8B,SACXC,EAAcT,EAASU,cAAcpB,EAAcC,IACnDoB,EAAWF,EAAYG,WAC7BN,EAAcO,EAAIF,EAClBF,EAAYK,cAAcC,aAAaJ,EAAUF,cAE9C/B,EAAcsC,eACdtC,EAAcuC,oBACXjC,EAASQ,EAAmBD,GAC5B2B,EAAOlB,EAASU,kBAAkB1B,OACxCkC,EAAKC,gBAAgBnC,GACrBsB,EAAcO,EAAIK,MAGxBvB,EAAcyB,IAAIvB,EAAWG,EAASqB,YACtCxB,EAAUyB,YAAYtB,GAExBF,EAAWM,WAAWC,SAAQ,SAAAC,GAC5BA,EAAciB,EAAEjB,EAAcO,4nCCpClC,IAwBIW,ECxBQC,EDANC,EAAWC,OAAO,MAyBXC,EAAa,SACxBC,EACAC,GAEAN,EAAiBM,MACbC,EAASF,WACbL,OAAiBQ,EACVD,IChCT,SAAYN,GACVA,6BACAA,uCACAA,yBACAA,mBACAA,0BALF,CAAYA,IAAAA,OAQZ,IAAIQ,EAAgC,GAChCC,GAA4B,EAiB1BC,EAAuB,SAAvBA,QACEC,EAAcC,KAAKD,MACnBE,EAAYL,EAClBA,EAAgB,OACVM,EAnBgB,SACtBC,EACAJ,UAEOI,EAAMC,QAAO,gBAAEZ,OAAIa,OAAWC,OAC7BC,EAAuBP,KAAKD,MAAQA,UACfC,KAAKD,MAAQM,EACvBC,GAAWC,EARJ,MAStBf,KACO,MAUWgB,CAAgBP,EAAWF,IACjDH,EAAgBM,EAAcO,OAAOb,IACnBc,OAAS,EACzBC,sBAAsBb,GAEtBD,GAAmB,GAGVe,EAAW,SACtBpB,EACAqB,mBAAAA,IAAAA,EAA0BzB,EAAc0B,QAEpCD,IAAazB,EAAc2B,UAGtB,IAAIC,SAAQ,SAAAC,GACjBrB,EAAcsB,KAAK,CACjB,WACE1B,IACAyB,KAEFjB,KAAKD,MACLc,IAEGhB,IACHc,sBAAsBb,GACtBD,GAAmB,OAbvBL,IAiBKwB,QAAQC,qBCnDDE,EAKdC,UAIQ,sCAAIC,2BAAAA,yBACH,SAACxC,GACNuC,gBAAQvC,EAAM+B,UAAaS,UCjBpBC,EAAOH,GAClB,SAACtC,EAAY+B,EAAoBW,GAC3B1C,aAAgB2C,MAClBZ,GAAS,WACP/B,EAAK4C,YAAcF,QCJrBG,EAA8C,IAAIrE,QAC3CsE,EAAQR,GACnB,SAACtC,EAAwB+B,EAAoBpB,GACvCX,aAAgB+C,mBACbF,EAAShE,IAAImB,KAChB6C,EAAS3C,IAAIF,EAAMA,EAAK0C,OACxB1C,EAAKgD,iBAAiB,SAAS,SAAAC,OACvBP,EAAiBO,EAAEC,OAA4BR,MACjDA,IAAUG,EAASM,IAAInD,KACzB+B,GAAS,kBAAMpB,EAAG+B,KAAQnC,EAAc6C,eACxCP,EAAS3C,IAAIF,EAAM0C,8BCLN,SAACW,EAAcC,GACtCC,eAAeC,OACbH,oFAEkC,IAIzBI,aAAa,CAAEC,KAAM,SAC1BhD,GACE,kBAAOiD,EAAKjF,OAAS4E,IAAQ5E,UAC7B,aACOkF,qBAGJA,4HAGCA,cAAA,sBACDC,KAAKC,oBACHA,cAAe,EACpB/B,GAAS,WACPrD,EAAOqF,EAAKC,WAAmBD,EAAKrF,YACnC6B,EAAc6C,eAAea,MAC9B,kBAAOF,EAAKD,cAAe,YArBrBI,uDPiCE,SAClBC,WAGItD,EAAqBtC,EAAY4E,IAAIgB,sBAFtCC,mCAAAA,uBAGEvD,EAuFE,KACDwD,EAAyB,EAC7BD,EAAajF,SAAQ,SAACuD,GACC,mBAAVA,IACT7B,EAAO3B,WAAWmF,GAAgBhE,EAAIqC,EACtC2B,YA5FO,SACPrG,EAAyB,GACvBkB,EAA8B,GAC3BoF,EAAI,EAAGA,EAAIF,EAAavC,OAAQyC,IAAK,KACtCC,EAAcH,EAAaE,GAC3BE,EAAaL,EAAYG,MAC/BtG,GAAkBwG,EACS,mBAAhBD,UAIPlG,EACFa,EAAWmD,KAAK,CACdhC,EAAGkE,IACA,EACHxG,EAAKC,EAAe6D,OAAS,EAC7B4C,GAAqB,EACrBC,GAAgB,EAChBC,GAAqB,EACrBC,EAAgB,GACb7G,KAAM,KACLE,EAAOD,EAAeE,OAAOH,GAC7B8G,EAAW7G,EAAeE,OAAOH,EAAK,GACtC+G,EAAe9G,EAAeE,OAAOH,EAAK,MACnC,MAATE,GAAuB,IAAPF,EAAU,KACxBD,EAASM,EAAcC,GAC3BL,OAAsBF,cAAkBA,MACxCoB,EAAWb,GAAIgB,EAAI7B,EAAc8B,cAIxB,MAATrB,GACa,MAAb4G,IACApH,EAASqH,IACRJ,KAKU,MAATzG,GAAiC,MAAjB6G,GAAyBL,MAM3CA,GACS,MAATxG,GACS,MAATA,IACC0G,IAEY,MAAT1G,EACF2G,EAAgB3G,EAAO2G,EAEvBD,GAAqB,GAGZ,MAAT1G,GAAgBwG,EAAoB,CACtCzG,EAAiBH,EACfS,EAAmBD,GACnBN,EACAC,GAEFkB,EAAWb,GAAIgB,EAAI7B,EAAcuC,gBACjCb,EAAWb,GAAI0G,EAAIH,EAC+B,MAA9C5G,EAAeA,EAAe6D,OAAS,KACzC7D,EAAiBA,EAAeG,MAAM,EAAGH,EAAe6D,OAAS,aAIxD,MAAT5D,IAAiBwG,EAAoB,CACvCzG,EAAiBH,EACfS,EAAmBD,GACnBN,EACAC,GAEFkB,EAAWb,GAAIgB,EAAI7B,EAAcsC,sBAnCjC2E,GAAqB,EACrBC,GAAgB,OALhBD,GAAqB,OA5BvBzG,GAAkBuG,EAwEtBvG,GAAkBmG,EAAYA,EAAYtC,OAAS,OAC7C9C,EAAWiG,SAASC,cAAc,YACxClG,EAASmG,UAAYlH,EACrB6C,EAAS,CACP9B,SAAAA,EACAG,WAAAA,UAWJX,EAAY2B,IAAIiE,EAAatD,GACtBA,uEEhHY,SAAoBsE,YAAAA,IAAAA,EAA2B,QAC9DvE,EAAWN,SAlCjB,SAAS8E,EAAQC,EAAUzE,OACnB0E,EAAQ,IAAIC,MAAMF,EAAK,CAC3BlC,IAAK,SAACkC,EAAKG,UAEPH,EAAIG,IACiB,iBAAdH,EAAIG,IACXH,EAAIG,GAAMC,OAASjF,IAEnB6E,EAAIG,GAAQJ,EAAQC,EAAIG,GAAO5E,IAE1ByE,EAAIG,IAEbtF,IAAK,SAACmF,EAAKG,EAAM9C,UACX2C,EAAIG,KAAU9C,GAAkB,SAAT8C,IACzBH,EAAIG,GAAQ9C,EACZ9B,MAEK,YAGX0E,EAAMG,KAAOjF,EACN8E,EAcAF,CAAQD,GAAc,kBAAMvE,GAAYA"}